{% extends "base.html" %}

{% block title %}Add Credential - JIT Inventory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-plus-lg"></i> Add Credential Profile</h2>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}

                <form method="POST">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="name" class="form-label">Profile Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name"
                                   placeholder="production-readonly" required
                                   value="{{ request.form.get('name', '') }}">
                        </div>
                        <div class="col-md-4">
                            <label for="version" class="form-label">SNMP Version <span class="text-danger">*</span></label>
                            <select class="form-select" id="version" name="version" onchange="toggleFields()">
                                <option value="v2c" {% if request.form.get('version', 'v2c') == 'v2c' %}selected{% endif %}>SNMPv2c</option>
                                <option value="v3" {% if request.form.get('version') == 'v3' %}selected{% endif %}>SNMPv3</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description"
                               placeholder="Read-only credentials for production network"
                               value="{{ request.form.get('description', '') }}">
                    </div>

                    <!-- SNMPv2c Fields -->
                    <div id="v2c-fields">
                        <div class="mb-3">
                            <label for="community" class="form-label">Community String <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="community" name="community"
                                   placeholder="public">
                        </div>
                    </div>

                    <!-- SNMPv3 Fields -->
                    <div id="v3-fields" style="display: none;">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" name="username"
                                   placeholder="snmpuser"
                                   value="{{ request.form.get('username', '') }}">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="auth_protocol" class="form-label">Auth Protocol</label>
                                <select class="form-select" id="auth_protocol" name="auth_protocol" onchange="toggleAuthPassword()">
                                    <option value="">None</option>
                                    <option value="MD5">MD5</option>
                                    <option value="SHA">SHA</option>
                                    <option value="SHA-224">SHA-224</option>
                                    <option value="SHA-256">SHA-256</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="auth_password" class="form-label">Auth Password</label>
                                <input type="password" class="form-control" id="auth_password" name="auth_password"
                                       placeholder="Authentication password" disabled>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="priv_protocol" class="form-label">Privacy Protocol</label>
                                <select class="form-select" id="priv_protocol" name="priv_protocol" onchange="togglePrivPassword()" disabled>
                                    <option value="">None</option>
                                    <option value="DES">DES</option>
                                    <option value="AES-128">AES-128</option>
                                    <option value="AES-256">AES-256</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="priv_password" class="form-label">Privacy Password</label>
                                <input type="password" class="form-control" id="priv_password" name="priv_password"
                                       placeholder="Encryption password" disabled>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> Save Profile
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleFields() {
    const version = document.getElementById('version').value;
    const v2cFields = document.getElementById('v2c-fields');
    const v3Fields = document.getElementById('v3-fields');
    const community = document.getElementById('community');
    const username = document.getElementById('username');

    if (version === 'v2c') {
        v2cFields.style.display = 'block';
        v3Fields.style.display = 'none';
        community.required = true;
        username.required = false;
    } else {
        v2cFields.style.display = 'none';
        v3Fields.style.display = 'block';
        community.required = false;
        username.required = true;
    }
}

function toggleAuthPassword() {
    const authProtocol = document.getElementById('auth_protocol').value;
    const authPassword = document.getElementById('auth_password');
    const privProtocol = document.getElementById('priv_protocol');

    if (authProtocol) {
        authPassword.disabled = false;
        privProtocol.disabled = false;
    } else {
        authPassword.disabled = true;
        authPassword.value = '';
        privProtocol.disabled = true;
        privProtocol.value = '';
        togglePrivPassword();
    }
}

function togglePrivPassword() {
    const privProtocol = document.getElementById('priv_protocol').value;
    const privPassword = document.getElementById('priv_password');

    if (privProtocol) {
        privPassword.disabled = false;
    } else {
        privPassword.disabled = true;
        privPassword.value = '';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleFields();
});
</script>
{% endblock %}

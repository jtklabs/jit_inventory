{% extends "base.html" %}

{% block title %}{{ device.hostname or device.ip_address }} - JIT Inventory{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{{ url_for('inventory') }}">Inventory</a></li>
                <li class="breadcrumb-item active">{{ device.hostname or device.ip_address }}</li>
            </ol>
        </nav>
        <h2><i class="bi bi-hdd-network"></i> {{ device.hostname or 'Unknown' }}</h2>
    </div>
    <div>
        {% if device.is_active %}
            <span class="badge bg-success fs-6">Active</span>
        {% else %}
            <span class="badge bg-secondary fs-6">Inactive</span>
        {% endif %}
    </div>
</div>

{% if error %}
    <div class="alert alert-danger">{{ error }}</div>
{% endif %}

<div class="row">
    <!-- Device Overview -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Device Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <th style="width: 35%;">IP Address</th>
                        <td><code>{{ device.ip_address }}</code></td>
                    </tr>
                    <tr>
                        <th>Hostname</th>
                        <td>{{ device.hostname or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Vendor</th>
                        <td>{{ device.vendor|capitalize if device.vendor else '-' }}</td>
                    </tr>
                    <tr>
                        <th>Device Type</th>
                        <td>{{ device.device_type or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Platform</th>
                        <td>{{ device.platform or '-' }}</td>
                    </tr>
                    <tr>
                        <th>Model</th>
                        <td><strong>{{ device.model or '-' }}</strong></td>
                    </tr>
                    <tr>
                        <th>Serial Number</th>
                        <td><code>{{ device.serial_number or '-' }}</code></td>
                    </tr>
                    <tr>
                        <th>Software Version</th>
                        <td><code>{{ device.software_version or '-' }}</code></td>
                    </tr>
                    <tr>
                        <th>sysObjectID</th>
                        <td><small class="text-muted">{{ device.sys_object_id or '-' }}</small></td>
                    </tr>
                    <tr>
                        <th>First Discovered</th>
                        <td>{{ device.first_discovered.strftime('%Y-%m-%d %H:%M') if device.first_discovered else '-' }}</td>
                    </tr>
                    <tr>
                        <th>Last Seen</th>
                        <td>{{ device.last_seen.strftime('%Y-%m-%d %H:%M') if device.last_seen else '-' }}</td>
                    </tr>
                    <tr>
                        <th>Credential Profile</th>
                        <td>
                            {% if device.credential_profile_name %}
                                <span class="badge bg-success">{{ device.credential_profile_name }}</span>
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>

                <!-- Action buttons -->
                <div class="mt-3 pt-3 border-top">
                    <form method="POST" action="{{ url_for('rescan_device', device_id=device.id) }}" class="d-inline">
                        <button type="submit" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-arrow-clockwise"></i> Rescan Device
                        </button>
                    </form>
                </div>
                <small class="text-muted d-block mt-1">
                    Rescan tries all credential profiles and collects full inventory
                </small>
            </div>
        </div>
    </div>
</div>

{% if inventory %}
<!-- Chassis / Stack Members -->
{% if inventory.stack_members and inventory.stack_members|length > 0 %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-stack"></i> Stack Members ({{ inventory.stack_members|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th>Switch</th>
                        <th>Model</th>
                        <th>Serial Number</th>
                        <th>Hardware Rev</th>
                        <th>Software Rev</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member in inventory.stack_members %}
                    <tr>
                        <td>
                            {# Switch number is index / 1000 (1000=1, 2000=2, etc.) #}
                            {% set switch_num = (member.index // 1000) %}
                            <span class="badge bg-primary">{{ switch_num }}</span>
                            {% if loop.first %}
                                <small class="text-muted">(Master)</small>
                            {% endif %}
                        </td>
                        <td><strong>{{ member.model or '-' }}</strong></td>
                        <td><code>{{ member.serial or '-' }}</code></td>
                        <td>{{ member.hardware_rev or '-' }}</td>
                        <td>{{ member.software_rev or '-' }}</td>
                        <td>{{ member.description[:30] if member.description else '-' }}{% if member.description and member.description|length > 30 %}...{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% elif inventory.chassis %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-cpu"></i> Chassis</h5>
    </div>
    <div class="card-body">
        <table class="table table-sm mb-0">
            <tr>
                <th style="width: 20%;">Description</th>
                <td>{{ inventory.chassis.description or '-' }}</td>
            </tr>
            <tr>
                <th>Model</th>
                <td><strong>{{ inventory.chassis.model or '-' }}</strong></td>
            </tr>
            <tr>
                <th>Serial Number</th>
                <td><code>{{ inventory.chassis.serial or '-' }}</code></td>
            </tr>
            <tr>
                <th>Hardware Revision</th>
                <td>{{ inventory.chassis.hardware_rev or '-' }}</td>
            </tr>
            <tr>
                <th>Software Revision</th>
                <td>{{ inventory.chassis.software_rev or '-' }}</td>
            </tr>
            <tr>
                <th>Manufacturer</th>
                <td>{{ inventory.chassis.manufacturer or '-' }}</td>
            </tr>
        </table>
    </div>
</div>
{% endif %}

<!-- Modules -->
{% if inventory.modules and inventory.modules|length > 0 %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-motherboard"></i> Modules ({{ inventory.modules|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        {% if inventory.is_stack %}
                        <th>Switch</th>
                        {% endif %}
                        <th>Name</th>
                        <th>Description</th>
                        <th>Model</th>
                        <th>Serial Number</th>
                        <th>Hardware Rev</th>
                        <th>FRU</th>
                    </tr>
                </thead>
                <tbody>
                    {% for module in inventory.modules %}
                    <tr>
                        {% if inventory.is_stack %}
                        <td>
                            {# Calculate which switch this module belongs to based on contained_in #}
                            {% set switch_num = ((module.contained_in or 0) // 1000) %}
                            {% if switch_num > 0 %}
                                <span class="badge bg-secondary">{{ switch_num }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>{{ module.name or '-' }}</td>
                        <td>{{ module.description[:40] if module.description else '-' }}{% if module.description and module.description|length > 40 %}...{% endif %}</td>
                        <td><strong>{{ module.model or '-' }}</strong></td>
                        <td><code>{{ module.serial or '-' }}</code></td>
                        <td>{{ module.hardware_rev or '-' }}</td>
                        <td>
                            {% if module.is_fru %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Power Supplies -->
{% if inventory.power_supplies and inventory.power_supplies|length > 0 %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Power Supplies ({{ inventory.power_supplies|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        {% if inventory.is_stack %}
                        <th>Switch</th>
                        {% endif %}
                        <th>Name</th>
                        <th>Model</th>
                        <th>Serial Number</th>
                    </tr>
                </thead>
                <tbody>
                    {% for psu in inventory.power_supplies %}
                    <tr>
                        {% if inventory.is_stack %}
                        <td>
                            {% set switch_num = ((psu.contained_in or 0) // 1000) %}
                            {% if switch_num > 0 %}
                                <span class="badge bg-secondary">{{ switch_num }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>{{ psu.name or psu.description or psu.model or '-' }}</td>
                        <td>{{ psu.model or '-' }}</td>
                        <td><code>{{ psu.serial or '-' }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Fans -->
{% if inventory.fans and inventory.fans|length > 0 %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-fan"></i> Fans ({{ inventory.fans|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        {% if inventory.is_stack %}
                        <th>Switch</th>
                        {% endif %}
                        <th>Name</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fan in inventory.fans %}
                    <tr>
                        {% if inventory.is_stack %}
                        <td>
                            {% set switch_num = ((fan.contained_in or 0) // 1000) %}
                            {% if switch_num > 0 %}
                                <span class="badge bg-secondary">{{ switch_num }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>{{ fan.name or '-' }}</td>
                        <td>{{ fan.description or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Licenses -->
{% if inventory.licenses and inventory.licenses|length > 0 %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-key"></i> Licenses ({{ inventory.licenses|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th>Feature</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Expiration</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lic in inventory.licenses %}
                    <tr>
                        <td><strong>{{ lic.feature_name or '-' }}</strong></td>
                        <td>
                            {% if lic.is_permanent %}
                                <span class="badge bg-success">{{ lic.license_type }}</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">{{ lic.license_type }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if lic.status == 'in_use' %}
                                <span class="badge bg-primary">In Use</span>
                            {% elif lic.status == 'not_in_use' %}
                                <span class="badge bg-secondary">Not In Use</span>
                            {% else %}
                                <span class="badge bg-light text-dark">{{ lic.status or '-' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if lic.end_date == 'Never' or lic.is_permanent %}
                                <span class="text-success">Never</span>
                            {% elif lic.end_date %}
                                {{ lic.end_date }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if lic.max_count and lic.max_count > 0 %}
                                {{ lic.count_remaining or 0 }} / {{ lic.max_count }}
                            {% else %}
                                <span class="text-muted">Unlimited</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<!-- sysDescr -->
{% if device.sys_description %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-file-text"></i> System Description</h5>
    </div>
    <div class="card-body">
        <pre class="mb-0" style="white-space: pre-wrap;">{{ device.sys_description }}</pre>
    </div>
</div>
{% endif %}

<!-- Recent Scan History -->
{% if scan_history %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Scan History</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Profile</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in scan_history %}
                    <tr>
                        <td>{{ scan.started_at.strftime('%Y-%m-%d %H:%M:%S') if scan.started_at else '-' }}</td>
                        <td><span class="badge bg-info">{{ scan.scan_type }}</span></td>
                        <td>
                            {% if scan.scan_status == 'success' %}
                                <span class="badge bg-success">Success</span>
                            {% else %}
                                <span class="badge bg-danger">Failed</span>
                            {% endif %}
                        </td>
                        <td>{{ scan.duration_ms or '-' }} ms</td>
                        <td>{{ scan.credential_profile_name or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Debug: All Entity Components -->
{% if inventory and inventory.all_components %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-bug"></i> All Entity Components (Debug)</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#allComponentsCollapse">
            Toggle
        </button>
    </div>
    <div class="collapse" id="allComponentsCollapse">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0" style="font-size: 0.85em;">
                    <thead>
                        <tr>
                            <th>Index</th>
                            <th>Class</th>
                            <th>Parent</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Model</th>
                            <th>Serial</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in inventory.all_components|sort(attribute='index') %}
                        {% if comp.entity_class in [3, 5, 6, 7, 9, 11] or comp.serial %}
                        <tr class="{% if comp.entity_class == 3 %}table-primary{% elif comp.entity_class == 11 %}table-info{% elif comp.entity_class == 6 %}table-warning{% endif %}">
                            <td><strong>{{ comp.index }}</strong></td>
                            <td>{{ comp.class_name or comp.entity_class }}</td>
                            <td>{{ comp.contained_in or '-' }}</td>
                            <td>{{ comp.name or '-' }}</td>
                            <td>{{ comp.description[:40] if comp.description else '-' }}{% if comp.description and comp.description|length > 40 %}...{% endif %}</td>
                            <td><code>{{ comp.model or '-' }}</code></td>
                            <td><code>{{ comp.serial or '-' }}</code></td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <small class="text-muted mt-2 d-block">
                Showing chassis (3, blue), stack (11, cyan), PSU (6, yellow), fans (7), containers (5), modules (9).
                Parent column shows contained_in index.
            </small>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
